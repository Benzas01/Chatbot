@page "/chat"
@using System.Text.Json
@using System.Net.Http;
@rendermode InteractiveServer
@inject HttpClient Http
@inject IJSRuntime JS

<PageTitle>AutoTech Support Chat</PageTitle>

<div class="chat-container">
    <div class="chat-header">
        <div class="header-content">
            <div class="brand-section">
                <div class="brand-icon">üöó</div>
                <div>
                    <h1>AutoTech Support</h1>
                    <p class="status-indicator">‚óè AI Assistant Online</p>
                </div>
            </div>
            <button class="clear-btn" @onclick="ClearChat">Clear Chat</button>
        </div>
    </div>

    <div class="chat-messages" @ref="messagesContainer">
        @if (messages.Count == 0)
        {
            <div class="welcome-message">
                <h2>üëã Welcome to AutoTech Customer Support</h2>
                <p>How can we assist you today? I can help with:</p>
                <div class="quick-options">
                    <button class="option-btn" @onclick="@(() => SendQuickMessage("I need help with vehicle maintenance"))">
                        üîß Vehicle Maintenance
                    </button>
                    <button class="option-btn" @onclick="@(() => SendQuickMessage("I want to know about warranty coverage"))">
                        üìã Warranty Information
                    </button>
                    <button class="option-btn" @onclick="@(() => SendQuickMessage("I need to schedule a service appointment"))">
                        üìÖ Service Appointment
                    </button>
                    <button class="option-btn" @onclick="@(() => SendQuickMessage("I have a question about my vehicle's features"))">
                        üí° Vehicle Features
                    </button>
                </div>
            </div>
        }
        
        @foreach (var message in messages)
        {
            <div class="message @(message.IsUser ? "user-message" : "bot-message")">
                <div class="message-avatar">
                    @if (message.IsUser)
                    {
                        <span>üë§</span>
                    }
                    else
                    {
                        <span>ü§ñ</span>
                    }
                </div>
                <div class="message-content">
                    <div class="message-header">
                        <strong>@(message.IsUser ? "You" : "AutoTech Assistant")</strong>
                        <span class="message-time">@message.Timestamp.ToString("HH:mm")</span>
                    </div>
                    <div class="message-text">@message.Text</div>
                </div>
            </div>
        }
        
        @if (isTyping)
        {
            <div class="message bot-message">
                <div class="message-avatar">
                    <span>ü§ñ</span>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            </div>
        }
    </div>

    <div class="chat-input-container">
        <div class="input-wrapper">
            <input 
                type="text" 
                class="chat-input" 
                placeholder="Type your message here..."
                @bind="currentMessage"
                @onkeypress="HandleKeyPress"
                disabled="@isTyping" />
            <button 
                class="send-btn" 
                @onclick="SendMessage"
                disabled="@(isTyping)">
                <span class="send-icon">‚û§</span>
            </button>
        </div>
        <div class="input-hint">
            Press Enter to send ‚Ä¢ Shift+Enter for new line
        </div>
    </div>
</div>

@code {
    private List<ChatMessage> messages = new();
    private string currentMessage = "";
    private bool isTyping = false;
    private ElementReference messagesContainer;

    protected override async Task OnInitializedAsync()
    {
        messages.Add(new ChatMessage
        {
            Text = "Hello! I'm your AutoTech virtual assistant. How can I help you today?",
            IsUser = false,
            Timestamp = DateTime.Now
        });
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(currentMessage)) return;

        var userMessage = currentMessage.Trim();
        currentMessage = "";

        messages.Add(new ChatMessage
        {
            Text = userMessage,
            IsUser = true,
            Timestamp = DateTime.Now
        });

        await ScrollToBottom();

        isTyping = true;
        StateHasChanged();

        // TODO: Replace this with actual API call
        var botResponse = await GetBotResponse(userMessage);

        await Task.Delay(500); // Simulate typing delay

        messages.Add(new ChatMessage
        {
            Text = botResponse,
            IsUser = false,
            Timestamp = DateTime.Now
        });

        isTyping = false;
        StateHasChanged();
        await ScrollToBottom();
    }

    private async Task SendQuickMessage(string message)
    {
        currentMessage = message;
        await SendMessage();
    }

    private async Task<string> GetBotResponse(string userMessage)
    {
        try
        {
            // 1. Prepare the data to send
            var requestData = new MessageRequest { content = userMessage };

            // 2. Send the POST request
            var response = await Http.PostAsJsonAsync("https://backendchatbot-production-a10b.up.railway.app/api/message", requestData);

            // 3. Check if the server answered successfully
            if (response.IsSuccessStatusCode)
            {
                // 4. Read the JSON answer and return the "response" property
                var result = await response.Content.ReadFromJsonAsync<MessageResponse>();
                return result?.response ?? "Error: Received an empty response.";
            }
            else
            {
                return $"Error: The server returned {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            return $"Connection error: {ex.Message}";
        }

    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && e.ShiftKey != true)
        {
            await SendMessage();
        }
    }

    private async Task ClearChat()
{
    messages.Clear();
    messages.Add(new ChatMessage
        {
            Text = "Chat cleared. How can I assist you?",
            IsUser = false,
            Timestamp = DateTime.Now
        });

    try
    {
        var response = await Http.PostAsync(
            "https://backendchatbot-production-a10b.up.railway.app/api/clear",
            null);

        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine($"Clear failed: {response.StatusCode}");
        }
    }
    catch (Exception ex)
    {
        Console.WriteLine($"Failed to notify backend: {ex.Message}");
    }

    StateHasChanged();
}

    private async Task ScrollToBottom()
    {
        await Task.Delay(100);
        StateHasChanged();
    }

    private class ChatMessage
    {
        public string Text { get; set; } = "";
        public bool IsUser { get; set; }
        public DateTime Timestamp { get; set; }
    }

    public class MessageRequest { public string content { get; set; } }

    public class MessageResponse { public string response { get; set; } }
}
